<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDK Test</title>
    <script src="bundle.js"></script>
    <script type="text/javascript">
        const nexusConfig = {
            walletUrl: 'https://localhost:3000', // Replace with the actual wallet URL
            metadata: {
                name: 'Your App Name',
                // Add any custom CSS if needed
            },
            domain: window.location.host
        };

        function setupNexusClient() {
            return new Promise((resolve) => {
                window.NexusSDK.createIframe({walletBaseUrl: nexusConfig.walletUrl}).then((iframe) => {
                    if (!iframe) {
                        console.error('Failed to create Nexus iframe');
                        resolve(null);
                    }

                    resolve(window.NexusSDK.createIFrameNexusClient({config: nexusConfig, iframe}));
                });
            });
        }

        // Export the setup function and config for use in other files
        window.NexusSetup = {setupNexusClient, nexusConfig};

        // wallet-status.js
        function displayWalletStatus() {
            const client = window.NexusSetup.nexusClient;
            const statusElement = document.getElementById('wallet-status');
            statusElement.textContent = 'Checking wallet status...';

            window.NexusSDK.watchWalletStatus(client, (status) => {
                statusElement.textContent = `Wallet status: ${status.key === 'connected' ? 'Connected' : 'Not connected'}`;

                if(status.key === 'connected') {
                    // Update Nexus context with wallet status
                    window.NexusSDK.NexusContextManager.replaceUrl({
                        url: window.location.href,
                        context: { r: status.wallet }
                    });
                }
            }).catch((error) => {
                statusElement.textContent = `Error: ${error.message}`;
            });
        }

        async function handleLogin() {
            // const client = await window.NexusSetup.setupNexusClient();
            // if (!client) {
            //   console.error('Nexus client not initialized');
            //   return;
            // }

            const loginButton = document.getElementById('login-button');
            loginButton.disabled = true;
            loginButton.textContent = 'Logging in...';

            try {
                await window.NexusSDK.displayModal(window.NexusSetup.nexusClient, {
                    steps: {
                        login: {},
                        success: {sharing: {text: 'Successfully logged in!'}}
                    }
                });
                loginButton.textContent = 'Logged In';
            } catch (error) {
                console.error('Login error:', error);
                loginButton.textContent = 'Login Failed';
            } finally {
                loginButton.disabled = false;
            }
        }

        window.onload = () => {
            console.log("NexusSDK", window.NexusSDK);
            setupNexusClient().then((nexusClient) => {
                console.log("nexusClient", nexusClient);
                if (!nexusClient) {
                    console.error('Failed to create Nexus client');
                    return;
                }

                window.NexusSetup.nexusClient = nexusClient;

                displayWalletStatus();

                const loginButton = document.getElementById('login-button');
                loginButton.addEventListener('click', handleLogin);
            });
        };
    </script>
</head>
<body>
<h1>Welcome to SDK Test</h1>
<p>This is a sample HTML document.</p>
<div id="wallet-status"></div>
<button type="button" id="login-button">Login</button>
</body>
</html>
