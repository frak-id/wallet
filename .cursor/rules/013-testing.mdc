---
description: Testing guidelines and best practices for unit tests and E2E tests
globs: **/*.test.ts, **/*.test.tsx, **/*.spec.ts, **/*.spec.tsx, **/vitest.config.ts, **/tests/**, test-setup/**/*
---
# Testing Rules

## Testing Commands

**CRITICAL**: Always use `bun run test` instead of `bun test` for unit tests.

### Unit Tests (Vitest 4.0 Projects API)

#### Workspace Mode (All Projects)
Run all 6 test projects (wallet, listener, business, wallet-shared, core-sdk, react-sdk) in parallel:
```bash
bun run test                  # Run all 179 test files (1927 tests) across all projects
bun run test:ui               # Run with Vitest UI for all projects
bun run test:coverage         # Run with coverage report for all projects
bun run test --project wallet-unit  # Run specific project only
```

#### Individual Projects
Run tests for a specific project:

**Wallet App**
```bash
cd apps/wallet
bun run test                  # Run wallet unit tests only
bun run test:ui               # Run with Vitest UI
bun run test:coverage         # Run with coverage report
```

**Listener App**
```bash
cd apps/listener
bun run test                  # Run listener unit tests only
bun run test:ui               # Run with Vitest UI
bun run test:coverage         # Run with coverage report
```

**Business App**
```bash
cd apps/business
bun run test                  # Run business unit tests only
bun run test:ui               # Run with Vitest UI
bun run test:coverage         # Run with coverage report
```

### E2E Tests (Playwright)

#### Wallet App
```bash
cd apps/wallet
bun run test:e2e              # Run tests against local
bun run test:e2e:dev          # Run tests against dev environment
bun run test:e2e:prod         # Run tests against prod environment
bun run test:e2e:ui           # Run with Playwright UI
```

## Test Framework

- **Unit Tests**: Vitest 4.0 with Projects API (workspace mode) and jsdom environment
  - 6 test projects: wallet-unit, listener-unit, business-unit, wallet-shared-unit, core-sdk-unit, react-sdk-unit
  - 179 test files, 1927 tests total
  - Parallel execution across all projects from root directory
- **Coverage**: v8 provider with 40% threshold (lines, functions, branches, statements)
- **E2E Tests**: Playwright for end-to-end testing
- **Testing Library**: @testing-library/react for React hooks and components

## Test Configuration Architecture

### Workspace Configuration (Vitest 4.0 Projects API)
- **`vitest.config.ts`** (root) - Workspace entry point, discovers all project configs
- **`test-setup/vitest.shared.ts`** - Shared configuration inherited by all projects:
  - Common settings: environment: "jsdom", timeouts, reporters, coverage thresholds
  - Individual projects extend with `mergeConfig(sharedConfig, defineConfig({...}))`

### Shared Test Setup Files
Located in `test-setup/` directory:

- **`shared-setup.ts`** - Browser API mocks for all projects:
  - `crypto.randomUUID` polyfill
  - `window.matchMedia` mock
  - `IntersectionObserver` mock
  - `ResizeObserver` mock
  - `MessageChannel` mock (for iframe communication)

- **`react-setup.ts`** - React-specific setup:
  - BigInt serialization for Zustand persist middleware

- **`wallet-mocks.ts`** - Wallet-specific mocks (wallet + wallet-shared):
  - Wagmi hooks (useAccount, useConnect, useBalance, etc.)
  - React Router hooks (useNavigate, useLocation, etc.)
  - WebAuthn API (ox library)
  - IndexedDB (idb-keyval)

- **`apps-setup.ts`** - Frontend app-specific setup:
  - Environment variables (STAGE, BACKEND_URL, etc.)
  - OpenPanel analytics mock
  - document.cookie mock

### Project-Specific Setup Files
Each project has its own setup file importing shared configurations:
- `apps/wallet/tests/vitest-setup.ts`
- `apps/listener/tests/vitest-setup.ts`
- `apps/business/tests/vitest-setup.ts`
- `packages/wallet-shared/tests/vitest-setup.ts`
- `sdk/core/tests/vitest-setup.ts`
- `sdk/react/tests/vitest-setup.ts`

## Test Organization

### Unit Test Location
- Co-locate tests with source files (e.g., `modalStore.test.ts` next to `modalStore.ts`)
- Use `*.test.ts` or `*.test.tsx` extension
- Setup files located in `tests/vitest-setup.ts`
- Tests should be placed in the same directory as the code they test

### Test File Structure
```typescript
import { describe, it, expect, beforeEach, vi } from "vitest";

describe("ComponentName", () => {
    beforeEach(() => {
        vi.clearAllMocks();
    });

    it("should do something specific", () => {
        // Arrange
        // Act
        // Assert
    });
});
```

## Mocking Strategies

### External Packages
Mock at module level with `vi.mock()`:
```typescript
vi.mock("@frak-labs/wallet-shared", () => ({
    get sessionStore() { return mockSessionStore; },
    getSafeSession: () => mockGetSafeSession(),
}));
```

### Zustand Stores
Create dual-purpose mocks (function + object with getState/subscribe):
```typescript
const mockSessionStore: any = Object.assign(
    vi.fn((selector: any) => {
        const state = { session: undefined };
        return selector(state);
    }),
    {
        getState: vi.fn(() => ({ session: undefined })),
        subscribe: vi.fn(() => vi.fn()),
    }
);
```

### Hoisting Issues
Use getter properties in `vi.mock()` to avoid hoisting issues:
```typescript
vi.mock("module", () => ({
    get value() { return mockValue; },  // Lazy evaluation
}));
```

### Common Mocks
- **Wagmi**: Mock hooks like `useAccount`, `usePublicClient`, `useWalletClient`
- **TanStack Query**: Mock `useQuery`, `useMutation`, `useQueryClient`
- **WebAuthn**: Mock `@simplewebauthn/browser` functions
- **react-i18next**: Mock `useTranslation`, `getI18n`

## Testing React Hooks

### Using renderHook
```typescript
import { renderHook, waitFor } from "@testing-library/react";

it("should update state", async () => {
    const { result } = renderHook(() => useMyHook());

    await waitFor(() => {
        expect(result.current.value).toBe(expectedValue);
    });
});
```

### Async Handlers
```typescript
it("should handle async operation", async () => {
    const { result } = renderHook(() => useAsyncHook());

    const promise = result.current.handler(params);

    await waitFor(() => {
        expect(mockFunction).toHaveBeenCalled();
    });

    await promise;
});
```

## Coverage Targets

### Required Coverage
- Lines: 40%
- Functions: 40%
- Branches: 40%
- Statements: 40%

### Coverage Exclusions
- UI components: `**/component/**/*.tsx`
- Entry points: `app/main.tsx`, `app/App.tsx`
- Build artifacts and node_modules
- Test files themselves

## Best Practices

### Test Independence
- Each test should be independent and not rely on other tests
- Use `beforeEach` to reset state between tests
- Clear all mocks with `vi.clearAllMocks()`

### Test Naming
- Use descriptive test names that explain what is being tested
- Format: "should [expected behavior] when [condition]"
- Example: "should emit connected status when wallet session exists"

### Test Coverage Focus
- Focus on business logic and state management
- Test error paths and edge cases
- Don't over-test implementation details
- Prioritize critical user flows

### Async Testing
- Always use `async/await` with `waitFor` for async operations
- Don't use arbitrary timeouts - let `waitFor` handle timing
- Test both success and error cases for async operations

### Mock Management
- Keep mocks close to the tests that use them
- Create reusable mock factories when needed
- Document complex mocking strategies
- Reset mocks between tests to avoid side effects

## Resource Tags

Use these tags to find relevant documentation:

- @Vitest - Vitest testing framework documentation
- @TestingLibrary - React Testing Library documentation
- @Playwright - Playwright E2E testing documentation
